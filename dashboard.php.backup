<?php
// إظهار جميع الأخطاء للتشخيص
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// بدء جلسة المستخدم - استخدام session_start() مباشرة بدلاً من التحقق
session_start();
require_once 'includes/language.php';
require_once 'config.php';

// تأكد من تسجيل دخول المستخدم
if (!isset($_SESSION['userid'])) {
    // إعادة توجيه المستخدم إلى صفحة تسجيل الدخول
    header("Location: login.php");
    exit();
}

// تخزين بيانات المستخدم من الجلسة
$user = $_SESSION['user'];
$user_id = $_SESSION['userid'];

// جلب الدورات المسجل بها المستخدم
$enrolled_courses = [];
try {
    $stmt = $pdo->prepare("
        SELECT 
            c.id, 
            c.name, 
            c.description, 
            c.image_url, 
            cat.name as category_name,
            e.enrollment_date
        FROM enrollments e
        JOIN courses c ON e.course_id = c.id
        JOIN categories cat ON c.category_id = cat.id
        WHERE e.user_id = ?
        ORDER BY e.enrollment_date DESC
    ");
    $stmt->execute([$user_id]);
    $enrolled_courses = $stmt->fetchAll();
} catch (PDOException $e) {
    echo '<div class="alert alert-danger">خطأ في قاعدة البيانات: ' . $e->getMessage() . '</div>';
}

// جلب جميع الدورات مجمعة حسب التصنيف
$courses_by_category = [];
try {
    $stmt = $pdo->query("
        SELECT 
            co.id, 
            co.name, 
            co.description, 
            co.image_url, 
            ca.name as category_name 
        FROM courses co
        JOIN categories ca ON co.category_id = ca.id
        ORDER BY ca.name, co.name
    ");
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $courses_by_category[$row['category_name']][] = $row;
    }
} catch (PDOException $e) {
    echo '<div class="alert alert-danger">خطأ في قاعدة البيانات: ' . $e->getMessage() . '</div>';
}

// تعيين عنوان الصفحة قبل تضمين الهيدر
$page_title = __('dashboard');
include 'includes/new-header.php';

?>

<div class="container my-5">
    <div class="p-4 mb-4 bg-light rounded-3 shadow-sm">
        <!-- الترحيب بالمستخدم -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-card">
                    <h1><?php echo __('welcome_back'); ?> <?php echo htmlspecialchars($_SESSION['name']); ?>!</h1>
                    <p><?php echo __('dashboard_welcome_text'); ?></p>
                </div>
            </div>
        </div>
        <!-- Enrolled Courses Section -->
        <div class="mb-5">
            <h2 class="pb-2 border-bottom mb-4" style="color: #005776;">
                <i class="bi bi-journal-check"></i> <?php echo __('my_courses'); ?>
            </h2>
            
            <?php if (empty($enrolled_courses)): ?>
                <!-- الدورات المسجل بها -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="section-header">
                            <i class="bi bi-journal-bookmark"></i>
                            <h2><?php echo __('my_courses'); ?></h2>
                        </div>
                    </div>
                </div>
            <?php else: ?>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <?php foreach ($enrolled_courses as $course): ?>
                        <div class="col">
                            <div class="card h-100 course-card border-success">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-success"><?php echo __('enrolled'); ?></span>
                                </div>
                                <img src="<?php echo htmlspecialchars($course['image_url']); ?>" class="card-img-top" 
                                     alt="<?php echo htmlspecialchars($course['name']); ?>">
                                <div class="card-body">
                                    <h5 class="card-title"><?php echo htmlspecialchars($course['name']); ?></h5>
                                    <p class="card-text"><?php echo htmlspecialchars($course['description']); ?></p>
                                    <a href="course_details.php?id=<?php echo $course['id']; ?>" class="btn btn-outline-success mt-auto">الذهاب للدورة</a>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>

        <!-- All Courses Section -->
        <div class="mb-5">
            <h2 class="pb-2 border-bottom mb-4" style="color: #005776;">
                <i class="bi bi-journal-bookmark"></i> <?php echo __('explore_courses'); ?>
            </h2>

            <?php if (empty($courses_by_category)): ?>
                <!-- الدورات المتاحة -->
                <div class="row">
                    <div class="col-12">
                        <div class="section-header">
                            <i class="bi bi-collection"></i>
                            <h2><?php echo __('available_courses'); ?></h2>
                        </div>
                    </div>
                </div>
            <?php else: ?>
                <ul class="nav nav-pills mb-4" id="coursesTab" role="tablist">
                    <?php $first = true; foreach (array_keys($courses_by_category) as $i => $category): ?>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link <?php echo $first ? 'active' : ''; ?>" 
                                    id="<?php echo 'cat-' . $i . '-tab'; ?>" 
                                    data-bs-toggle="pill" 
                                    data-bs-target="<?php echo '#cat-' . $i; ?>" 
                                    type="button" 
                                    role="tab" 
                                    aria-controls="<?php echo 'cat-' . $i; ?>" 
                                    aria-selected="<?php echo $first ? 'true' : 'false'; ?>">
                                <?php echo htmlspecialchars($category); ?>
                            </button>
                        </li>
                    <?php $first = false; endforeach; ?>
                </ul>

                <div class="tab-content" id="coursesTabContent">
                    <?php $first = true; foreach ($courses_by_category as $i => $courses): ?>
                        <div class="tab-pane fade <?php echo $first ? 'show active' : ''; ?>" 
                             id="<?php echo 'cat-' . array_search($i, array_keys($courses_by_category)); ?>" 
                             role="tabpanel" 
                             aria-labelledby="<?php echo 'cat-' . array_search($i, array_keys($courses_by_category)) . '-tab'; ?>">
                            
                            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                                <?php foreach ($courses_by_category[$i] as $course): 
                                    // Check if user already enrolled in this course
                                    $is_enrolled = false;
                                    foreach ($enrolled_courses as $enrolled) {
                                        if ($enrolled['id'] == $course['id']) {
                                            $is_enrolled = true;
                                            break;
                                        }
                                    }
                                    // Skip if already enrolled
                                    if ($is_enrolled) continue;
                                ?>
                                    <div class="col">
                                        <div class="card h-100 course-card">
                                            <img src="<?php echo htmlspecialchars($course['image_url']); ?>" class="card-img-top" 
                                                 alt="<?php echo htmlspecialchars($course['name']); ?>">
                                            <div class="card-body">
                                                <h5 class="card-title"><?php echo htmlspecialchars($course['name']); ?></h5>
                                                <p class="card-text"><?php echo htmlspecialchars($course['description']); ?></p>
                                                <a href="course_details.php?id=<?php echo $course['id']; ?>" class="btn btn-primary mt-auto align-self-<?php echo get_current_direction() === 'rtl' ? 'start' : 'end'; ?>"><?php echo __('view_details'); ?></a>
                                            </div>
                                        <img src="<?php echo htmlspecialchars($course['image_url']); ?>" class="card-img-top" alt="<?php echo htmlspecialchars($course['name']); ?>">
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title"><?php echo htmlspecialchars($course['name']); ?></h5>
                                            <p class="card-text flex-grow-1"><?php echo htmlspecialchars($course['description']); ?></p>
                                            <a href="course_details.php?id=<?php echo $course['id']; ?>" class="btn btn-primary mt-auto align-self-<?php echo get_current_direction() === 'rtl' ? 'start' : 'end'; ?>"><?php echo __('view_details'); ?></a>
                                        </div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                <?php $first = false; endforeach; ?>
            </div>
        <?php endif; ?>
    </div>
</div>

<?php include 'includes/new-footer.php'; ?>
